<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .search-container button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #errorMessage {
            color: #f44336;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #resultCard {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .result-header h2 {
            color: #4CAF50;
        }
        
        #printButton {
            padding: 5px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        table th {
            background-color: #f5f5f5;
        }
        
        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            text-align: center;
        }
        
        .signatures img {
            max-width: 150px;
            margin-bottom: 5px;
        }
        
        .grade-a {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .grade-b {
            color: #2196F3;
            font-weight: bold;
        }
        
        .grade-c {
            color: #FF9800;
            font-weight: bold;
        }
        
        .grade-f {
            color: #f44336;
            font-weight: bold;
        }
        
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .fail {
            color: #f44336;
            font-weight: bold;
        }
        
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .search-container, #printButton {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 20px;">Exam Results Portal</h1>
        
        <!-- Search Form -->
        <div class="search-container">
            <input type="text" id="rollNumber" placeholder="Enter Roll Number">
            <button onclick="fetchResult()">Get Result</button>
        </div>
        
        <!-- Error Message -->
        <div id="errorMessage" style="display: none;">
            No results found for the given roll number. Please check and try again.
        </div>
        
        <!-- Result Card -->
        <div id="resultCard" style="display: none;">
            <div class="result-header">
                <h2>Exam Result Card</h2>
                <button id="printButton">Print Result</button>
            </div>
            
            <div class="student-info">
                <div>
                    <strong>Name:</strong> <span id="studentName"></span>
                </div>
                <div>
                    <strong>Roll Number:</strong> <span id="studentRoll"></span>
                </div>
                <div>
                    <strong>Class:</strong> <span id="studentClass"></span>
                </div>
                <div>
                    <strong>School:</strong> <span id="schoolName"></span>
                </div>
                <div>
                    <strong>Exam:</strong> <span id="examName"></span>
                </div>
                <div>
                    <strong>Year:</strong> <span id="examYear"></span>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Max Marks</th>
                        <th>Obtained</th>
                        <th>Grade</th>
                    </tr>
                </thead>
                <tbody id="marksTableBody">
                    <!-- Rows will be added dynamically -->
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Total</strong></td>
                        <td id="totalMax"></td>
                        <td id="totalObtained"></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="result-summary">
                <div>
                    <strong>Percentage:</strong> <span id="percentage"></span>%
                </div>
                <div>
                    <strong>CGPA:</strong> <span id="cgpa"></span>
                </div>
                <div>
                    <strong>Result:</strong> <span id="resultStatus"></span>
                </div>
            </div>
            
            <div class="signatures">
                <div>
                    <img id="examInchargeSignature" alt="Exam Incharge Signature">
                    <p>Exam Incharge</p>
                </div>
                <div>
                    <img id="principalSignature" alt="Principal Signature">
                    <p>Principal</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend proxy URLs - we'll try direct access first, then fallback to the proxy
        const BACKEND_DIRECT_URL = 'https://exam-results-portal-backend.onrender.com/api/exam-results';
        const BACKEND_PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(BACKEND_DIRECT_URL);
        
        // Debug mode - set to true to see detailed logs
        const DEBUG = true;
        
        // Helper function for debugging
        function debugLog(...args) {
            if (DEBUG) {
                console.log(...args);
            }
        }
        
        async function checkBackendHealth() {
            try {
                const healthURL = 'https://exam-results-portal-backend.onrender.com/health';
                debugLog("Checking backend health at:", healthURL);
                
                const response = await fetch(healthURL);
                
                if (!response.ok) {
                    debugLog("Health check failed with status:", response.status);
                    return false;
                }
                
                const data = await response.json();
                debugLog("Health check response:", data);
                return data.status === 'healthy';
                
            } catch (error) {
                debugLog("Health check error:", error);
                return false;
            }
        }
        
        async function fetchWithRetry(url, options, retries = 2) {
            try {
                debugLog("Fetching from:", url);
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    debugLog("Fetch failed with status:", response.status);
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                return response;
            } catch (error) {
                debugLog("Fetch error:", error);
                
                if (retries <= 0) throw error;
                
                // If direct URL failed, try with CORS proxy
                if (url === BACKEND_DIRECT_URL && retries > 0) {
                    debugLog("Retrying with CORS proxy");
                    return fetchWithRetry(BACKEND_PROXY_URL, options, retries - 1);
                }
                
                throw error;
            }
        }

        async function fetchResult() {
            const rollNumber = document.getElementById('rollNumber').value;
            const resultCard = document.getElementById('resultCard');
            const errorMessage = document.getElementById('errorMessage');
            
            if (!rollNumber) {
                errorMessage.textContent = "Please enter a roll number";
                errorMessage.style.display = 'block';
                resultCard.style.display = 'none';
                return;
            }
            
            // Reset display
            resultCard.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Show loading indicator
            errorMessage.textContent = "Loading...";
            errorMessage.style.display = 'block';
            
            try {
                // First check if backend is healthy
                const isHealthy = await checkBackendHealth();
                
                if (!isHealthy) {
                    errorMessage.textContent = "Backend server appears to be offline. Please try again later.";
                    errorMessage.style.display = 'block';
                    return;
                }
                
                // Set up fetch options
                const fetchOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                };
                
                // Try to fetch with potential CORS proxy fallback
                const response = await fetchWithRetry(
                    `${BACKEND_DIRECT_URL}?rollNumber=${rollNumber}`, 
                    fetchOptions
                );
                
                const data = await response.json();
                debugLog("API Response:", data);
                
                if (data.status === 'success' && data.student) {
                    errorMessage.style.display = 'none';
                    displayResult(data.student, rollNumber);
                    resultCard.style.display = 'block';
                } else {
                    errorMessage.textContent = data.message || "No results found for the given roll number. Please check and try again.";
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching result:', error);
                errorMessage.textContent = "Error connecting to the server. Please try again later.";
                errorMessage.style.display = 'block';
                
                // Show detailed error in console
                debugLog("Detailed error:", error);
            }
        }

        function calculateGrade(marks) {
            if (marks >= 90) return 'A';
            else if (marks >= 80) return 'B';
            else if (marks >= 70) return 'C';
            else if (marks >= 60) return 'D';
            else return 'F';
        }

        function getGradeClass(grade) {
            switch(grade) {
                case 'A': return 'grade-a';
                case 'B': return 'grade-b';
                case 'C': return 'grade-c';
                case 'F': return 'grade-f';
                default: return '';
            }
        }
        
        function displayResult(data, rollNumber) {
            debugLog("Displaying result for:", data);
            
            // Set student info
            document.getElementById('studentName').textContent = data.name || 'N/A';
            document.getElementById('studentRoll').textContent = rollNumber;
            document.getElementById('studentClass').textContent = data.class || 'N/A';
            document.getElementById('examYear').textContent = new Date().getFullYear();
            document.getElementById('schoolName').textContent = data.school || 'PM SHRI KENDRIYA VIDYALAYA RAEBARELI';
            document.getElementById('examName').textContent = 'Final Term';
            
            try {
                // Set signature images - using default paths if not provided
                document.getElementById('examInchargeSignature').src = 'Exam Incharge.png';
                document.getElementById('principalSignature').src = 'principal/HM-signature.png';
            } catch (error) {
                debugLog("Error setting signature images:", error);
            }
            
            // Clear previous table rows
            const tableBody = document.getElementById('marksTableBody');
            tableBody.innerHTML = '';
            
            // Add subject rows if exists
            if (Array.isArray(data.subjects) && data.subjects.length > 0) {
                data.subjects.forEach(subject => {
                    const row = document.createElement('tr');
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = subject.name || 'N/A';
                    
                    const maxMarksCell = document.createElement('td');
                    maxMarksCell.textContent = subject.maxMarks || '0';
                    
                    const obtainedCell = document.createElement('td');
                    obtainedCell.textContent = subject.obtained || '0';
                    
                    const gradeCell = document.createElement('td');
                    gradeCell.textContent = subject.grade || 'N/A';
                    gradeCell.className = getGradeClass(subject.grade);
                    
                    row.appendChild(nameCell);
                    row.appendChild(maxMarksCell);
                    row.appendChild(obtainedCell);
                    row.appendChild(gradeCell);
                    
                    tableBody.appendChild(row);
                });
            } else {
                debugLog("No subjects data found");
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 4;
                cell.textContent = "No subject data available";
                cell.style.textAlign = "center";
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
            
            // Set summary information
            document.getElementById('totalObtained').textContent = data.totalObtained || '0';
            document.getElementById('totalMax').textContent = data.totalMarks || '0';
            document.getElementById('percentage').textContent = data.percentage || '0';
            document.getElementById('cgpa').textContent = data.cgpa || '0';
            
            // Set result
            const resultStatus = document.getElementById('resultStatus');
            resultStatus.textContent = data.result || 'N/A';
            resultStatus.className = data.result === 'PASS' ? 'pass' : 'fail';
        }
        
        // Add event listener for print button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('printButton').addEventListener('click', function() {
                window.print();
            });
        });
    </script>
</body>
</html>
